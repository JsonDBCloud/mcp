# CI Pipeline Design

## Overview

Add a full CI pipeline (lint, type-check, test, build) that gates both PRs and npm publishing. The existing `publish.yml` is modified to depend on CI passing.

## Architecture

Two workflows, chained:

1. **`ci.yml`** — runs on PRs to main and pushes to main
   - Lint (ESLint)
   - Format check (Prettier)
   - Type-check (`tsc --noEmit`)
   - Test (Vitest)
   - Build (`tsup`)
   - Node matrix: 18, 22

2. **`publish.yml`** (existing, modified) — triggers via `workflow_run` after CI completes on main
   - Only runs if CI succeeded (`conclusion == 'success'`)
   - No other changes to publish logic

## Linting

- ESLint 9+ flat config with `@typescript-eslint/parser` + recommended rules
- Prettier with project-matching settings: semicolons, double quotes, trailing commas, 2-space indent
- Scripts: `lint`, `format:check`

## Testing

Framework: Vitest

### What to test

1. **`buildFilterObject()`** — pure function in `collections.ts` with branching logic (eq shortcut, operator mapping, unknown operator fallback). ~5-6 cases.
2. **`success()` / `error()` helpers** — lock down MCP response format. ~3 cases.
3. **Tool registration smoke tests** — mock `McpServer` and `JsonDB`, call each `register*Tools()`, verify `server.tool()` called with expected tool names. One test file per tool module.
4. **Tool handler behavior** — invoke handler callbacks with mocked SDK, verify success/error responses for happy path and error status codes (404, 409, 400). ~5-8 cases.

### What not to test

- No integration tests against real jsondb.cloud API
- No stdio transport or MCP server lifecycle tests

### File structure

```
src/__tests__/
  helpers.test.ts
  build-filter.test.ts
  tools/
    documents.test.ts
    collections.test.ts
    schemas.test.ts
    versions.test.ts
    webhooks.test.ts
```

## Workflow Details

### ci.yml

```yaml
name: CI
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
jobs:
  ci:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 22]
    steps:
      - checkout
      - setup-node (matrix version)
      - npm ci
      - npm run lint
      - npx prettier --check .
      - npx tsc --noEmit
      - npm test
      - npm run build
```

### publish.yml (modified trigger)

```yaml
on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
jobs:
  publish:
    if: github.event.workflow_run.conclusion == 'success'
    # ... existing steps unchanged
```
